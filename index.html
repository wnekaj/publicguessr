<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family Fortunes — Poll Edition</title>
  <style>
    :root {
      --bg: #0f172a;      /* slate-900 */
      --card: #111827;    /* gray-900 */
      --muted: #94a3b8;   /* slate-400 */
      --text: #e5e7eb;    /* gray-200 */
      --accent: #38bdf8;  /* sky-400 */
      --success: #34d399; /* emerald-400 */
      --danger: #f87171;  /* red-400 */
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 50% -10%, #1f2937, var(--bg));
      color: var(--text);
      display: grid; place-items: center;
    }
    .app { width: min(920px, 92vw); }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
    }
    .title {
      font-size: clamp(22px, 3.5vw, 34px);
      margin: 6px 0 2px; font-weight: 800; letter-spacing: 0.3px;
    }
    .subtitle { color: var(--muted); margin: 0 0 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    input[type="text"] {
      flex: 1 1 280px; font-size: 18px; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
      background: rgba(17,24,39,0.7); color: var(--text); outline: none;
    }
    input[type="text"]::placeholder { color: #9ca3af; }
    button {
      border: none; border-radius: 12px; padding: 12px 16px; font-size: 16px; font-weight: 700; cursor: pointer;
      background: linear-gradient(180deg, var(--accent), #0284c7); color: #06131a;
      transition: transform 0.05s ease-in-out; user-select: none;
    }
    button.secondary { background: linear-gradient(180deg, #6ee7b7, #059669); color: #062016; }
    button.ghost { background: transparent; border: 1px dashed rgba(255,255,255,0.2); color: var(--text); }
    button:active { transform: translateY(1px); }

    .board { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 18px 0; }
    .tile {
      background: #0b1220; border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 14px 16px;
      display: flex; align-items: center; justify-content: space-between; min-height: 58px; font-weight: 800;
    }
    .tile.revealed { background: #0e1a2c; }
    .answer { text-transform: uppercase; letter-spacing: 0.5px; }
    .points { color: var(--accent); font-variant-numeric: tabular-nums; }

    .hud { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .score { font-weight: 800; font-size: 18px; }
    .strikes { display: flex; gap: 6px; align-items: center; }
    .strike {
      width: 22px; height: 22px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15);
      display: grid; place-items: center; font-weight: 900; color: var(--danger);
      background: rgba(255,0,0,0.08);
    }
    .pill { font-size: 12px; padding: 6px 10px; border: 1px solid rgba(255,255,255,0.12); border-radius: 999px; color: var(--muted); }

    details.howto { margin-top: 12px; }
    details.howto summary { cursor: pointer; color: var(--accent); font-weight: 700; }
    .footer { color: var(--muted); font-size: 12px; text-align: center; margin-top: 10px; }
    .hidden { display: none !important; }

    @media (max-width: 640px) {
      .board { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="pill">Prototype</div>
      <h1 class="title">Family Fortunes — Poll Edition</h1>
      <p class="subtitle" id="questionText">Loading…</p>

      <div class="row" style="margin-bottom: 8px;">
        <input id="guessInput" type="text" placeholder="Type an answer…" autocomplete="off" />
        <button id="guessBtn">Submit</button>
        <button id="passBtn" class="ghost" title="Skip to next question">Pass</button>
      </div>

      <div class="board" id="board"></div>

      <div class="hud">
        <div class="score">Score: <span id="score">0</span></div>
        <div class="strikes" aria-live="polite">
          <span>Strikes:</span>
          <div id="strike1" class="strike">×</div>
          <div id="strike2" class="strike">×</div>
          <div id="strike3" class="strike">×</div>
        </div>
        <button id="nextBtn" class="secondary hidden">Next question</button>
      </div>

      <details class="howto"><summary>How do I add my polling data?</summary>
        <div style="margin-top: 10px; color: var(--text);">
          <ol>
            <li>Replace the <code>QUESTIONS</code> array in the script with your own questions and answers (top 5–8). Use <code>score</code> as the % from your poll.</li>
            <li>Optionally, publish a Google Sheet as CSV and fetch it (see commented code near <code>loadQuestions()</code>).</li>
            <li>Re-deploy by uploading this single file to Netlify / Vercel / GitHub Pages.</li>
          </ol>
        </div>
      </details>
    </div>

    <p class="footer">Built as a learning starter. No frameworks, no build tools — just one file.</p>
  </div>

<script>
// ASCII-safe script (no template strings or “smart quotes”)

var QUESTIONS = [
  {
    question: "Name a bill people most worry about going up",
    answers: [
      { text: "Energy", aliases: ["gas", "electric", "electricity", "power", "heating"], score: 42 },
      { text: "Rent", aliases: ["renting"], score: 18 },
      { text: "Mortgage", aliases: ["mortgages"], score: 14 },
      { text: "Water", aliases: ["water rates"], score: 10 },
      { text: "Council Tax", aliases: ["council", "local tax"], score: 9 },
      { text: "Food", aliases: ["groceries", "supermarket"], score: 5 }
    ]
  }
];

// ===== state =====
var idx = 0, score = 0, revealed = new Set(), strikes = 0;
var els = {
  questionText: document.getElementById("questionText"),
  board: document.getElementById("board"),
  input: document.getElementById("guessInput"),
  guessBtn: document.getElementById("guessBtn"),
  passBtn: document.getElementById("passBtn"),
  nextBtn: document.getElementById("nextBtn"),
  score: document.getElementById("score"),
  strike1: document.getElementById("strike1"),
  strike2: document.getElementById("strike2"),
  strike3: document.getElementById("strike3")
};

function norm(s){ return s.toLowerCase().replace(/[^a-z0-9\s-]/g, "").trim(); }

function renderQuestion(){
  if (!QUESTIONS || !QUESTIONS.length) {
    els.questionText.textContent = "No questions loaded. Check your Google Sheet publishing settings.";
    els.board.innerHTML = "";
    els.nextBtn.classList.add("hidden");
    return;
  }
  var q = QUESTIONS[idx];
  els.questionText.textContent = q.question;
  els.board.innerHTML = "";
  revealed = new Set(); strikes = 0; updateStrikes();
  els.nextBtn.classList.add("hidden");
  els.input.value = ""; try{ els.input.focus(); }catch(_){}

  var count = Math.min(q.answers.length, 8);
  for (var i=0;i<count;i++){
    var tile = document.createElement("div");
    tile.className = "tile";
    tile.setAttribute("data-index", String(i));
    tile.innerHTML = '<span class="answer">- - -</span><span class="points">??</span>';
    els.board.appendChild(tile);
  }
}

function reveal(i){
  var q = QUESTIONS[idx], ans = q.answers[i], tile = els.board.children[i];
  if (!tile || !ans) return;
  tile.classList.add("revealed");
  tile.querySelector(".answer").textContent = ans.text;
  tile.querySelector(".points").textContent = String(ans.score);
  revealed.add(i);
  score += ans.score;
  els.score.textContent = String(score);
  var total = Math.min(q.answers.length, els.board.children.length);
  if (revealed.size >= total) els.nextBtn.classList.remove("hidden");
}

function updateStrikes(){ [els.strike1,els.strike2,els.strike3].forEach(function(el,i){
  el.style.opacity = (strikes > i ? 1 : 0.25);
});}

function handleGuess(){
  var guess = norm(els.input.value); if (!guess) return;
  var q = QUESTIONS[idx], foundIndex = -1;
  q.answers.forEach(function(ans,i){
    if (foundIndex !== -1) return;
    if (revealed.has(i)) return;
    var candidates = [ans.text].concat(ans.aliases||[]).map(norm);
    if (candidates.indexOf(guess) !== -1) foundIndex = i;
  });
  if (foundIndex !== -1){
    reveal(foundIndex); els.input.value = ""; try{ els.input.focus(); }catch(_){}
  } else {
    strikes = Math.min(strikes+1,3); updateStrikes();
    if (strikes >= 3){
      q.answers.forEach(function(_,i){ if (!revealed.has(i)) reveal(i); });
      els.nextBtn.classList.remove("hidden");
    }
  }
}
function nextQuestion(){ idx = (idx+1) % QUESTIONS.length; renderQuestion(); }
els.guessBtn.addEventListener("click", handleGuess);
els.input.addEventListener("keydown", function(e){ if (e.key === "Enter") handleGuess(); });
els.passBtn.addEventListener("click", nextQuestion);
els.nextBtn.addEventListener("click", nextQuestion);

// ===== Google Sheets loader (CSV first, then GViz JSONP) =====
var SHEET_PUBLISHED_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6_gEjPFb7k4tHmguxmp_4qHlObR7JAY5V1UtktCGS0BbfoehJd13fYv5iI4qZ1HjlEwkUxGqM0Aod/pubhtml";

function normalizeToCSV(url){
  if (!url) return "";
  var m = /gid=([0-9]+)/.exec(url);
  var gid = m ? "&gid=" + m[1] : "";
  if (/\/pubhtml(\?|$)/.test(url)) return url.replace(/\/pubhtml(\?.*)?$/, "/pub?output=csv" + gid);
  if (/\/pub(\?|$)/.test(url) && url.indexOf("output=csv") === -1) return url.replace(/\/pub(\?.*)?$/, "/pub?output=csv");
  return url;
}

function parseCSV(text){
  var rows=[],row=[],field="",inQuotes=false,i,c;
  for(i=0;i<text.length;i++){
    c=text[i];
    if (inQuotes){
      if (c === '"'){ if (text[i+1] === '"'){ field += '"'; i++; } else { inQuotes=false; } }
      else { field += c; }
    } else {
      if (c === '"') inQuotes = true;
      else if (c === ","){ row.push(field); field=""; }
      else if (c === "\n"){ row.push(field); rows.push(row); row=[]; field=""; }
      else if (c === "\r"){ }
      else { field += c; }
    }
  }
  if (field.length || row.length){ row.push(field); rows.push(row); }
  return rows;
}

function loadViaCSV(publishedUrl){
  var csvUrl = normalizeToCSV(publishedUrl);
  return fetch(csvUrl, { cache: "no-store" })
    .then(function(resp){ if(!resp.ok) throw new Error("HTTP "+resp.status); return resp.text(); })
    .then(function(text){ var rows = parseCSV(text); if(!rows.length) throw new Error("Empty CSV"); return rows; });
}

function loadViaGvizJSONP(publishedUrl, timeoutMs){
  timeoutMs = timeoutMs || 8000;
  return new Promise(function(resolve,reject){
    try{
      var base = publishedUrl.replace(/\/pubhtml(\?.*)?$/, "");
      if (!/\/gviz\/tq/.test(base)){
        base = base.replace(/\/edit(\?.*)?$/, "");
        if (base.charAt(base.length-1) === "/") base = base.slice(0,-1);
        base += "/gviz/tq";
      }
      var m = /gid=([0-9]+)/.exec(publishedUrl);
      var gid = m ? m[1] : "";
      var gvizUrl = base + "?tqx=out:json" + (gid ? "&gid=" + gid : "");

      var cbName = "gviz_cb_" + Math.random().toString(36).slice(2);
      var timer = setTimeout(function(){ cleanup(); reject(new Error("GViz timeout")); }, timeoutMs);
      function cleanup(){ clearTimeout(timer); if(script && script.parentNode) script.parentNode.removeChild(script); try{ delete window[cbName]; }catch(_){ window[cbName]=undefined; } }

      window[cbName] = function(response){
        cleanup();
        try{
          if (!response || !response.table) throw new Error("No table");
          var cols = response.table.cols.map(function(c){ return (c && c.label ? String(c.label).trim().toLowerCase() : ""); });
          var qi = cols.indexOf("question"), ai = cols.indexOf("answer"), si = cols.indexOf("score"), li = cols.indexOf("aliases");
          if (qi<0 || ai<0 || si<0) throw new Error("Missing headers");
          var rows = [cols];
          response.table.rows.forEach(function(r){
            var vals = r.c.map(function(c){ return (c && c.v != null ? String(c.v) : ""); });
            rows.push(vals);
          });
          resolve(rows);
        }catch(e){ reject(e); }
      };

      var script = document.createElement("script");
      script.src = gvizUrl + "&tq&" + (gid ? "gid=" + gid + "&" : "") + "tqx=out:json&callback=" + cbName;
      script.async = true;
      script.onerror = function(){ cleanup(); reject(new Error("GViz script error")); };
      document.head.appendChild(script);
    }catch(e){ reject(e); }
  });
}

function rowsToQA(rows){
  var header = rows[0].map(function(h){ return String(h||"").trim().toLowerCase(); });
  var qi = header.indexOf("question"), ai = header.indexOf("answer"), si = header.indexOf("score"), li = header.indexOf("aliases");
  if (qi<0 || ai<0 || si<0) throw new Error("Missing required headers");
  var byQ = new Map();
  rows.slice(1).forEach(function(row){
    if (!row || !row.length) return;
    var q = (row[qi]||"").trim();
    var a = (row[ai]||"").trim();
    var sText = String(row[si] == null ? "" : row[si]).trim();
    var sNum = Number(sText.replace(/[^0-9.+-]/g, ""));
    var l = li >= 0 ? (row[li] || "") : "";
    if (!q || !a) return;
    if (!byQ.has(q)) byQ.set(q, []);
    byQ.get(q).push({ text:a, score: isFinite(sNum)? sNum : 0, aliases: l.split("|").map(function(x){return x.trim();}).filter(function(x){return !!x;}) });
  });
  var out = [];
  byQ.forEach(function(answers, question){ answers.sort(function(x,y){return y.score - x.score;}); out.push({question:question, answers:answers}); });
  if (!out.length) throw new Error("Parsed 0 questions");
  return out;
}

function loadQuestions(){
  return loadViaCSV(SHEET_PUBLISHED_URL)
    .then(function(rows){ var out = rowsToQA(rows); console.log("Loaded " + out.length + " questions via CSV"); return out; })
    .catch(function(csvErr){
      console.warn("CSV load failed, trying GViz JSONP...", csvErr);
      return loadViaGvizJSONP(SHEET_PUBLISHED_URL)
        .then(function(rows){ var out = rowsToQA(rows); console.log("Loaded " + out.length + " questions via GViz JSONP"); return out; })
        .catch(function(gvizErr){ console.warn("GViz load failed, using embedded QUESTIONS", gvizErr); return QUESTIONS; });
    });
}

(function init(){
  loadQuestions()
    .then(function(data){
      if (data && data.length){
        if (data !== QUESTIONS){ while (QUESTIONS.length) QUESTIONS.pop(); data.forEach(function(q){ QUESTIONS.push(q); }); }
      }
      renderQuestion();
    })
    .catch(function(err){ console.error("Init failed", err); renderQuestion(); });
})();
</script>
</body>
</html>
